{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}

<div id="game-container" style="position: relative; width: 100%; height: 60vh; border: 1px solid #ccc; overflow: hidden;">
    <div id="ball" style="
        position: absolute;
        z-index:999;
        top: 100px;
        left: 100px;
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background-color: red;
        cursor: pointer;
    "></div>

    <div class="card mx-auto mt-3" style="max-width: 600px;">
        <div class="card-body">
            <h3 class="card-title">Welcome, {{ session.get('user_name', 'User') }}!</h3>
            <p class="card-text"><strong>Email:</strong> {{ session.get('user_email', 'Not available') }}</p>

            <hr>

            <p>ðŸ•’ Active Time Following Ball: <span id="activeTimeDisplay">0m 0s</span></p>
            <p>ðŸ“Š Total Active Time On Site: <span id="totalActiveTimeDisplay">{{ total_active_minutes }}m {{ total_active_seconds }}s</span></p>

            <ul class="list-unstyled mt-3">
                <li><a href="{{ url_for('auth.leaderboard') }}" class="btn btn-primary">Leaderboard</a></li>
            </ul>

            <a href="{{ url_for('auth.logout') }}" class="btn btn-secondary mt-3">Logout</a>
        </div>
    </div>
</div>

<script>
const ball = document.getElementById("ball");
const container = document.getElementById("game-container");
const activeDisplay = document.getElementById("activeTimeDisplay");
const totalDisplay = document.getElementById("totalActiveTimeDisplay");

// --- Timers ---
let sessionActiveSeconds = 0;
let pendingActiveSeconds = 0;
let totalActiveSeconds = {{ total_active_minutes }}*60 + {{ total_active_seconds }};
let lastFollowTime = Date.now();
let lastSecondUpdate = Date.now();

// --- Ball properties ---
let ballSize = 80;
let ballSpeed = 1;
let elapsedTime = 0;
let posX = 100;
let posY = 100;
let angle = Math.random() * 2 * Math.PI;

const jitterChangeInterval = 0.2;
const maxAngleChange = 0.2;

// --- Container bounds ---
function updateBounds() {
    containerWidth = container.clientWidth;
    containerHeight = container.clientHeight;
}
updateBounds();
window.addEventListener("resize", updateBounds);

// --- Mouse tracking ---
let mouseX = 0;
let mouseY = 0;
document.addEventListener("mousemove", (e) => {
    const rect = container.getBoundingClientRect();
    mouseX = e.clientX - rect.left;
    mouseY = e.clientY - rect.top;
});

// --- Main game loop ---
function gameLoop() {
    const now = Date.now();

    if (Math.random() < jitterChangeInterval) {
        angle += (Math.random() * 2 - 1) * maxAngleChange;
    }

    posX += Math.cos(angle) * ballSpeed;
    posY += Math.sin(angle) * ballSpeed;

    // Bounce off edges
    if (posX < 0) { posX = 0; angle = Math.PI - angle; }
    if (posY < 0) { posY = 0; angle = -angle; }
    if (posX + ballSize > container.clientWidth) { posX = container.clientWidth - ballSize; angle = Math.PI - angle; }
    if (posY + ballSize > container.clientHeight) { posY = container.clientHeight - ballSize; angle = -angle; }

    ball.style.left = posX + "px";
    ball.style.top = posY + "px";
    ball.style.width = ballSize + "px";
    ball.style.height = ballSize + "px";

    const mouseOverBall =
        mouseX >= posX && mouseX <= posX + ballSize &&
        mouseY >= posY && mouseY <= posY + ballSize;

    if (mouseOverBall) {
        if (now - lastSecondUpdate >= 1000) {
            sessionActiveSeconds++;
            pendingActiveSeconds++;
            totalActiveSeconds++;
            lastSecondUpdate = now;
        }
        lastFollowTime = now;
    }

    activeDisplay.textContent = `${Math.floor(sessionActiveSeconds / 60)}m ${sessionActiveSeconds % 60}s`;
    totalDisplay.textContent = `${Math.floor(totalActiveSeconds / 60)}m ${totalActiveSeconds % 60}s`;

    elapsedTime += 1 / 60; // approx 60 FPS
    const progress = Math.min(elapsedTime / 300, 1);
    ballSpeed = 1 + 1.5 * progress;
    ballSize = 80 - 30 * progress;

    if (now - lastFollowTime > 30000) {
        if (pendingActiveSeconds > 0) {
            navigator.sendBeacon("/update_active_time",
                new Blob([JSON.stringify({ active_seconds: pendingActiveSeconds })], { type: 'application/json' }));
        }
        window.location.href = "{{ url_for('auth.logout') }}";
        return;
    }

    requestAnimationFrame(gameLoop);
}

requestAnimationFrame(gameLoop);

// --- Periodic backend update every 30s ---
setInterval(() => {
    if (pendingActiveSeconds > 0) {
        fetch("/update_active_time", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ active_seconds: pendingActiveSeconds })
        }).catch(err => console.error("Active time update failed:", err));
        pendingActiveSeconds = 0;
    }
}, 30000);
</script>

{% endblock %}
