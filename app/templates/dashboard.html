{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}

<div id="game-container" style="position: relative; width: 100%; height: 60vh; border: 1px solid #ccc; overflow: hidden;">
    <div id="ball" style="
        position: absolute;
        z-index:999;
        top: 100px;
        left: 100px;
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background-color: red;
        cursor: pointer;
    "></div>

    <div class="card mx-auto mt-3" style="max-width: 600px;">
        <div class="card-body">
            <h3 class="card-title">Welcome, {{ session.get('user_name', 'User') }}!</h3>
            <p class="card-text"><strong>Email:</strong> {{ session.get('user_email', 'Not available') }}</p>

            <hr>
            <p>‚è± Active Following Ball Timer: <span id="activeFollowTimer">0m 0s</span></p>
            <p>‚è≥ Inactivity Countdown: <span id="inactivityCountdown">30</span>s</p>
            <p>üìä Total Active Time On Site: <span id="totalActiveTimeDisplay">{{ total_active_minutes }}m {{ total_active_seconds }}s</span></p>

            <ul class="list-unstyled mt-3">
                <li><a href="{{ url_for('auth.leaderboard') }}" class="btn btn-primary">Leaderboard</a></li>
            </ul>

            <a href="{{ url_for('auth.logout') }}" class="btn btn-secondary mt-3">Logout</a>
        </div>
    </div>
</div>

<script>
const ball = document.getElementById("ball");
const container = document.getElementById("game-container");
const activeFollowDisplay = document.getElementById("activeFollowTimer");
const inactivityCountdownDisplay = document.getElementById("inactivityCountdown");
const totalDisplay = document.getElementById("totalActiveTimeDisplay");

let sessionActiveSeconds = 0;
let totalActiveSeconds = {{ total_active_minutes }}*60 + {{ total_active_seconds }};
let pendingActiveSeconds = 0;

let inactivityCountdown = 30;
let lastFollowTime = Date.now();
let lastActiveUpdate = Date.now();
let lastInactivityUpdate = Date.now();
let following = false;

// Ball motion
let ballSize = 80;
let posX = 100;
let posY = 100;
let angle = Math.random() * 2 * Math.PI;

function updateBounds() {
    containerWidth = container.clientWidth;
    containerHeight = container.clientHeight;
}
updateBounds();
window.addEventListener("resize", updateBounds);

let mouseX = 0, mouseY = 0;
document.addEventListener("mousemove", (e) => {
    const rect = container.getBoundingClientRect();
    mouseX = e.clientX - rect.left;
    mouseY = e.clientY - rect.top;
});

// Main loop
function gameLoop() {
    const now = Date.now();

    // Move ball
    if (Math.random() < 0.2) angle += (Math.random()*2-1)*0.2;
    posX += Math.cos(angle);
    posY += Math.sin(angle);

    // Bounce
    if (posX < 0){ posX = 0; angle = Math.PI - angle; }
    if (posY < 0){ posY = 0; angle = -angle; }
    if (posX + ballSize > container.clientWidth){ posX = container.clientWidth - ballSize; angle = Math.PI - angle; }
    if (posY + ballSize > container.clientHeight){ posY = container.clientHeight - ballSize; angle = -angle; }

    ball.style.left = posX + "px";
    ball.style.top = posY + "px";

    // Following detection
    following = mouseX >= posX && mouseX <= posX + ballSize &&
                mouseY >= posY && mouseY <= posY + ballSize;
    if (following) lastFollowTime = now;

    // Active-following timer
    if (following && now - lastActiveUpdate >= 1000) {
        sessionActiveSeconds++;
        pendingActiveSeconds++;
        totalActiveSeconds++;
        lastActiveUpdate = now;
    }

    // Inactivity countdown
    if (!following && inactivityCountdown > 0 && now - lastInactivityUpdate >= 1000) {
        inactivityCountdown--;
        lastInactivityUpdate = now;
    }

    // Update displays
    activeFollowDisplay.textContent = `${Math.floor(sessionActiveSeconds/60)}m ${sessionActiveSeconds%60}s`;
    inactivityCountdownDisplay.textContent = inactivityCountdown;
    totalDisplay.textContent = `${Math.floor(totalActiveSeconds/60)}m ${totalActiveSeconds%60}s`;

    // Inactivity logout
    if (inactivityCountdown <= 0) {
        endSession("inactivity");
        return;
    }

    requestAnimationFrame(gameLoop);
}
requestAnimationFrame(gameLoop);

// Periodic backend update every 30s
setInterval(() => {
    if (pendingActiveSeconds > 0){
        fetch("/update_active_time", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({active_seconds: pendingActiveSeconds})
        }).catch(err => console.error(err));
        pendingActiveSeconds = 0;
    }
}, 30000);

// End session function
function endSession(reason="unload") {
    if (pendingActiveSeconds > 0){
        navigator.sendBeacon("/update_active_time", new Blob(
            [JSON.stringify({active_seconds: pendingActiveSeconds})], 
            {type:"application/json"}
        ));
        pendingActiveSeconds = 0;
    }

    if (reason === "inactivity") {
        // Only log out on inactivity
        navigator.sendBeacon("/logout");
        window.location.href = "/";
    }
}

// Only update active time on unload, no logout
window.addEventListener("beforeunload", ()=>endSession("unload"));
</script>


{% endblock %}
